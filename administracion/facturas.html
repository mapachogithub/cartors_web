<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="facturas.css">
    <title>Facturas</title>
</head>
<body>
    <div id="admin-header-placeholder"></div>

    <div class="main-container">
        <section class="new-invoice">
            <h2>Crear Nueva Factura</h2>
            <form id="newInvoiceForm">
                <div class="form-group">
                    <label for="nombreFactura">Nombre o # de Factura:</label>
                    <input type="text" id="nombreFactura" name="nombreFactura" required>
                </div>
                <div class="form-group">
                    <label for="cliente">Cliente:</label>
                    <input type="text" id="cliente" name="cliente" required>
                </div>
                <div class="form-group">
                    <label for="fechaEmision">Fecha de Emisión:</label>
                    <input type="date" id="fechaEmision" name="fechaEmision">
                </div>
                <div class="form-group">
                    <label for="valorTotal">Valor Total:</label>
                    <input type="number" id="valorTotal" name="valorTotal" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="estado">Estado:</label>
                    <select id="estado" name="estado">
                        <option value="Pendiente">Pendiente</option>
                        <option value="Pagada">Pagada</option>
                        <option value="Anulada">Anulada</option>
                    </select>
                </div>
                <button type="button" class="create-button" onclick="agregarFactura()">Crear Factura</button>
            </form>
        </section>

        <section class="invoice-list">
            <h2>Listado de Facturas <img src="../images/facturas-logo.png" alt="Logo de Facturas" class="page-logo-small"></h2>
            <table id="tablaFacturas">
                <thead>
                    <tr>
                        <th>Nombre o # de Factura</th>
                        <th>Cliente</th>
                        <th>Fecha Emisión</th>
                        <th>Valor Total</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="tablaFacturasBody">
                </tbody>
            </table>
        </section>

        <section class="monthly-summary">
            <h2>Resumen Anual y Mensual de Facturas</h2>
            <div id="yearlySummaryContainer">
                </div>
            <div class="total-general-box">
                <h3>Total General de Facturas: <span id="totalGeneralFacturas"></span></h3>
                <p>IVA (19%) del Total General: <span id="ivaTotalGeneralFacturas"></span></p>
            </div>
        </section>

    </div>

    <div id="admin-footer-placeholder"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getDatabase, ref, onValue, push, remove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";
        import { firebaseConfig } from './firebaseConfig.js'; // ¡Verifica esta ruta!

        // Inicializa Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const facturasRef = ref(database, 'facturas'); // Referencia a la colección de facturas
        const tablaFacturasBody = document.getElementById('tablaFacturasBody');
        const yearlySummaryContainer = document.getElementById('yearlySummaryContainer');
        const totalGeneralFacturasSpan = document.getElementById('totalGeneralFacturas');
        const ivaTotalGeneralFacturasSpan = document.getElementById('ivaTotalGeneralFacturas');

        const IVA_RATE = 0.19; // 19% IVA

        function eliminarFactura(key) {
            if (confirm('¿Estás seguro de que deseas eliminar esta factura?')) {
                const facturaRef = ref(database, `facturas/${key}`);
                remove(facturaRef)
                    .then(() => {
                        alert('Factura eliminada con éxito.');
                    })
                    .catch((error) => {
                        console.error("Error al eliminar la factura:", error);
                        alert('Error al eliminar la factura. Por favor, intenta de nuevo.');
                    });
            }
        }

        function mostrarFacturas(data) {
            tablaFacturasBody.innerHTML = '';
            yearlySummaryContainer.innerHTML = '';
            let totalGeneral = 0;
            const facturasPorAño = {};

            if (data) {
                const sortedFacturas = Object.entries(data).sort(([, a], [, b]) => {
                    return new Date(a.fechaEmision) - new Date(b.fechaEmision);
                });

                sortedFacturas.forEach(([key, factura]) => {
                    const row = tablaFacturasBody.insertRow();

                    let cell = row.insertCell();
                    cell.textContent = factura.nombreFactura || 'N/A'; // Mostrar el nombre de la factura
                    cell.dataset.label = 'Nombre Factura';

                    cell = row.insertCell();
                    cell.textContent = factura.cliente || 'N/A';
                    cell.dataset.label = 'Cliente';

                    cell = row.insertCell();
                    cell.textContent = factura.fechaEmision || 'N/A';
                    cell.dataset.label = 'Fecha Emisión';

                    const valor = parseFloat(factura.valorTotal);
                    const ivaValor = valor * IVA_RATE;
                    cell = row.insertCell();
                    cell.innerHTML = `$${valor ? valor.toLocaleString('es-CO') : 'N/A'}<br><small>IVA (19%): $${ivaValor.toLocaleString('es-CO')}</small>`;
                    cell.dataset.label = 'Valor Total';

                    cell = row.insertCell();
                    cell.textContent = factura.estado || 'N/A';
                    cell.dataset.label = 'Estado';

                    const accionesCell = row.insertCell();
                    const eliminarButton = document.createElement('button');
                    eliminarButton.textContent = 'Eliminar';
                    eliminarButton.classList.add('eliminar-btn');
                    eliminarButton.onclick = () => eliminarFactura(key);
                    accionesCell.appendChild(eliminarButton);
                    accionesCell.dataset.label = 'Acciones';

                    if (factura.fechaEmision && valor) {
                        const date = new Date(factura.fechaEmision);
                        const year = date.getFullYear();
                        const month = date.getMonth();
                        const monthName = new Date(year, month, 1).toLocaleString('es-ES', { month: 'long' });
                        const yearMonthKey = `${year}-${month.toString().padStart(2, '0')}`;

                        if (!facturasPorAño[year]) {
                            facturasPorAño[year] = {
                                total: 0,
                                ivaTotal: 0,
                                meses: {}
                            };
                        }
                        if (!facturasPorAño[year].meses[yearMonthKey]) {
                            facturasPorAño[year].meses[yearMonthKey] = {
                                name: monthName,
                                total: 0,
                                ivaTotal: 0,
                                facturas: []
                            };
                        }
                        facturasPorAño[year].total += valor;
                        facturasPorAño[year].ivaTotal += ivaValor;
                        facturasPorAño[year].meses[yearMonthKey].total += valor;
                        facturasPorAño[year].meses[yearMonthKey].ivaTotal += ivaValor;
                        facturasPorAño[year].meses[yearMonthKey].facturas.push({ id: key, ...factura });
                        totalGeneral += valor;
                    }
                });

                const sortedYears = Object.keys(facturasPorAño).sort((a, b) => parseInt(a) - parseInt(b));

                sortedYears.forEach(year => {
                    const yearData = facturasPorAño[year];
                    const yearBox = document.createElement('div');
                    yearBox.classList.add('year-summary-box');
                    yearBox.innerHTML = `
                        <h2>${year}</h2>
                        <div class="monthly-summary-grid">
                            </div>
                        <p class="yearly-total">Total Anual: <strong>$${yearData.total.toLocaleString('es-CO')}</strong><br>
                        IVA (19%) del Total Anual: <strong>$${yearData.ivaTotal.toLocaleString('es-CO')}</strong></p>
                    `;
                    const monthlyGrid = yearBox.querySelector('.monthly-summary-grid');

                    const sortedMonths = Object.keys(yearData.meses).sort();
                    sortedMonths.forEach(monthKey => {
                        const monthData = yearData.meses[monthKey];
                        const monthBox = document.createElement('div');
                        monthBox.classList.add('month-box');
                        monthBox.innerHTML = `
                            <h3>${monthData.name} ${year}</h3>
                            <ul class="monthly-invoice-list">
                                ${monthData.facturas.map(f => {
                                    const facturaValor = parseFloat(f.valorTotal);
                                    const facturaIVA = facturaValor * IVA_RATE;
                                    return `
                                    <li>
                                        Nombre: ${f.nombreFactura || 'N/A'} - Cliente: ${f.cliente} - Valor: $${facturaValor.toLocaleString('es-CO')}<br>
                                        <small>IVA (19%): $${facturaIVA.toLocaleString('es-CO')}</small>
                                    </li>
                                `;
                                }).join('')}
                            </ul>
                            <p class="monthly-total">Total del mes: <strong>$${monthData.total.toLocaleString('es-CO')}</strong><br>
                            IVA (19%) del mes: <strong>$${monthData.ivaTotal.toLocaleString('es-CO')}</strong></p>
                        `;
                        monthlyGrid.appendChild(monthBox);
                    });
                    yearlySummaryContainer.appendChild(yearBox);
                });

                totalGeneralFacturasSpan.textContent = `$${totalGeneral.toLocaleString('es-CO')}`;
                ivaTotalGeneralFacturasSpan.textContent = `$${(totalGeneral * IVA_RATE).toLocaleString('es-CO')}`;

            } else {
                const row = tablaFacturasBody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 6;
                cell.textContent = 'No hay facturas registradas.';
                totalGeneralFacturasSpan.textContent = '$0,00';
                ivaTotalGeneralFacturasSpan.textContent = '$0,00';
            }
        }

        function agregarFactura() {
            const form = document.getElementById('newInvoiceForm');
            const nombreFactura = form.nombreFactura.value; // Capturar el nombre de la factura
            const cliente = form.cliente.value; // Capturar el cliente del campo de texto
            const fechaEmision = form.fechaEmision.value;
            const valorTotal = form.valorTotal.value;
            const estado = form.estado.value;

            if (nombreFactura && cliente && valorTotal) {
                const nuevaFactura = {
                    nombreFactura: nombreFactura,
                    cliente: cliente,
                    fechaEmision: fechaEmision,
                    valorTotal: parseFloat(valorTotal),
                    estado: estado
                };

                push(facturasRef, nuevaFactura)
                    .then(() => {
                        alert('Nueva factura añadida con éxito.');
                        form.reset();
                    })
                    .catch((error) => {
                        console.error("Error al añadir la factura:", error);
                        alert('Error al añadir la factura. Por favor, intenta de nuevo.');
                    });
            } else {
                alert('Los campos Nombre de Factura, Cliente y Valor Total son obligatorios.');
            }
        }

        onValue(facturasRef, (snapshot) => {
            const data = snapshot.val();
            mostrarFacturas(data);
        }, (error) => {
            console.error("Error al leer datos de Firebase:", error);
            tablaFacturasBody.innerHTML = '<tr><td colspan="6">Error al cargar las facturas.</td></tr>';
            totalGeneralFacturasSpan.textContent = '$0,00';
            ivaTotalGeneralFacturasSpan.textContent = '$0,00';
        });

        window.agregarFactura = agregarFactura;
    </script>

    <script src="../administracion/OBJECTS JS/admin_header.js"></script>
    <script src="../administracion/OBJECTS JS/footer_objetc.js"></script>
</body>
</html>