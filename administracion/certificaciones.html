<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA==" crossorigin="anonymous" referrerpolicy="no-referrer">
    <link rel="stylesheet" href="certificaciones.css">
    <title>Certificaciones emitidas</title>
</head>
<body>
    <header>
        <div class="header-container">
            <h1>Panel de Administración</h1>
            <nav>
                <ul>
                    <li><a href="admin.html">Inicio</a></li>
                    <li><a href="nuestros_clientes.html">Inventario de Clientes</a></li>
                    <li><a href="nuestros_empleados.html">Nuestros Empleados</a></li>
                    <li><a href="certificaciones.html">Certificaciones</a></li>
                    <li><a href="certificaciones_pendientes.html">Certificaciones por emitir</a></li>
                    <li><a href="facturas.html">Facturas</a></li>
                    <li><a href="../index.html">Cerrar Sesión</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main>
        <section class="centrado">
            <h2>Listado de Empresas Certificadas</h2>
            <p>Aquí se muestra el registro de las empresas certificadas con sus detalles y opciones de gestión.</p>

            <div class="formulario-nueva-certificacion">
                <h3>Añadir Nueva Certificación</h3>
                <form id="nuevaCertificacionForm">
                    <div class="form-row">
                        <label for="empresa">Empresa:</label>
                        <input type="text" id="empresa" name="empresa" required>
                    </div>
                    <div class="form-row">
                        <label for="certificada">¿Certificada?</label>
                        <select id="certificada" name="certificada">
                            <option value="Sí">Sí</option>
                            <option value="No">No</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <label for="motivo">Motivo:</label>
                        <input type="text" id="motivo" name="motivo">
                    </div>
                    <div class="form-row">
                        <label for="observaciones">Observaciones:</label>
                        <input type="text" id="observaciones" name="observaciones">
                    </div>
                    
                    <div class="form-row">
                        <label for="correo">Enviar al Correo:</label>
                        <input type="email" id="correo" name="correo" placeholder="correo@empresa.com">
                    </div>
                    <button type="button" onclick="agregarCertificacion()">Añadir Certificación</button>
                </form>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>Empresa</th>
                        <th>¿Certificada?</th>
                        <th>Motivo</th>
                        <th>Observaciones</th>
                        <th>Subir Certificación (PDF)</th>
                        <th>Enviar al Correo</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="tablaCertificacionesBody">
                    <tr>
                        <td data-label="Empresa">Tech Solutions</td>
                        <td data-label="¿Certificada?">
                            <select name="certified_techsolutions">
                                <option value="Sí" selected>Sí</option>
                                <option value="No">No</option>
                            </select>
                        </td>
                        <td data-label="Motivo">Cumplimiento de normas ISO 9001</td>
                        <td data-label="Observaciones">Revisión anual completada.</td>
                        <td data-label="Subir Certificación (PDF)">
                            <input type="file" accept=".pdf" name="cert_techsolutions">
                        </td>
                        <td data-label="Enviar al Correo">
                            <input type="email" placeholder="correo@empresa.com" name="email_techsolutions">
                            <button>Enviar</button>
                        </td>
                        <td data-label="Acciones"><button class="eliminar-btn" onclick="eliminarFila(this)">Eliminar</button></td>
                    </tr>
                    <tr>
                        <td data-label="Empresa">Eco Energy</td>
                        <td data-label="¿Certificada?">
                            <select name="certified_ecoenergy">
                                <option value="Sí">Sí</option>
                                <option value="No" selected>No</option>
                            </select>
                        </td>
                        <td data-label="Motivo">Falta de documentación</td>
                        <td data-label="Observaciones">Pendiente de auditoría.</td>
                        <td data-label="Subir Certificación (PDF)">
                            <input type="file" accept=".pdf" name="cert_ecoenergy">
                        </td>
                        <td data-label="Enviar al Correo">
                            <input type="email" placeholder="correo@empresa.com" name="email_ecoenergy">
                            <button>Enviar</button>
                        </td>
                        <td data-label="Acciones"><button class="eliminar-btn" onclick="eliminarFila(this)">Eliminar</button></td>
                    </tr>
                    <tr>
                        <td data-label="Empresa">Global Logistics</td>
                        <td data-label="¿Certificada?">
                            <select name="certified_globallogistics">
                                <option value="Sí" selected>Sí</option>
                                <option value="No">No</option>
                            </select>
                        </td>
                        <td data-label="Motivo">Certificación ambiental aprobada</td>
                        <td data-label="Observaciones">Válida hasta 2026.</td>
                        <td data-label="Subir Certificación (PDF)">
                            <input type="file" accept=".pdf" name="cert_globallogistics">
                        </td>
                        <td data-label="Enviar al Correo">
                            <input type="email" placeholder="correo@empresa.com" name="email_globallogistics">
                            <button>Enviar</button>
                        </td>
                        <td data-label="Acciones"><button class="eliminar-btn" onclick="eliminarFila(this)">Eliminar</button></td>
                    </tr>
                </tbody>
            </table>
        </section>
    </main>

    <footer>
        <p>© 2025 Cartor's SAS.</p>
        <p>Todos los derechos reservados.</p>
        <br>
        <p>Codificación y edición:</p>
        <p>Francisco Quiñones Maldonado</p>
        <p>Soluciones Tecnológicas</p>
    </footer>

    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getDatabase, ref, onValue, push, remove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";
    import { firebaseConfig } from './firebaseConfig.js'; //  <-  ¡Verifica esta ruta!

    // Inicializa Firebase
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const certificacionesRef = ref(database, 'certificaciones-emitidas'); // Nueva referencia para certificaciones emitidas
    const tablaCertificacionesBody = document.getElementById('tablaCertificacionesBody');

    function eliminarCertificacion(key) {
        if (confirm('¿Estás seguro de que deseas eliminar esta certificación?')) {
            const certificacionRef = ref(database, `certificaciones-emitidas/${key}`);
            remove(certificacionRef)
                .then(() => {
                    alert('Certificación eliminada con éxito.');
                    // La tabla se actualizará automáticamente gracias al listener onValue
                })
                .catch((error) => {
                    console.error("Error al eliminar la certificación:", error);
                    alert('Error al eliminar la certificación. Por favor, intenta de nuevo.');
                });
        }
    }

    function mostrarCertificaciones(data) {
        tablaCertificacionesBody.innerHTML = ''; // Limpia la tabla
        if (data) {
            Object.entries(data).forEach(([key, certificacion]) => {
                const row = tablaCertificacionesBody.insertRow();

                let cell = row.insertCell();
                cell.textContent = certificacion.empresa || 'N/A';
                cell.dataset.label = 'Empresa';

                cell = row.insertCell();
                const selectCertificada = document.createElement('select');
                selectCertificada.name = `certified_${(certificacion.empresa || '').toLowerCase().replace(/\s/g, '')}`;
                const optionSi = document.createElement('option');
                optionSi.value = 'Sí';
                optionSi.textContent = 'Sí';
                optionSi.selected = certificacion.certificada === 'Sí';
                const optionNo = document.createElement('option');
                optionNo.value = 'No';
                optionNo.textContent = 'No';
                optionNo.selected = certificacion.certificada === 'No';
                selectCertificada.appendChild(optionSi);
                selectCertificada.appendChild(optionNo);
                cell.appendChild(selectCertificada);
                cell.dataset.label = '¿Certificada?';

                cell = row.insertCell();
                cell.textContent = certificacion.motivo || 'N/A';
                cell.dataset.label = 'Motivo';

                cell = row.insertCell();
                cell.textContent = certificacion.observaciones || 'N/A';
                cell.dataset.label = 'Observaciones';

                cell = row.insertCell();
                const inputFile = document.createElement('input');
                inputFile.type = 'file';
                inputFile.accept = '.pdf';
                inputFile.name = `cert_${(certificacion.empresa || '').toLowerCase().replace(/\s/g, '')}`;
                cell.appendChild(inputFile);
                cell.dataset.label = 'Subir Certificación (PDF)';

                cell = row.insertCell();
                const emailInput = document.createElement('input');
                emailInput.type = 'email';
                emailInput.placeholder = 'correo@empresa.com';
                emailInput.name = `email_${(certificacion.empresa || '').toLowerCase().replace(/\s/g, '')}`;
                emailInput.value = certificacion.correo || '';
                const enviarButton = document.createElement('button');
                enviarButton.textContent = 'Enviar';
                cell.appendChild(emailInput);
                cell.appendChild(enviarButton);
                cell.dataset.label = 'Enviar al Correo';

                // Columna de acciones con el botón Eliminar
                const accionesCell = row.insertCell();
                const eliminarButton = document.createElement('button');
                eliminarButton.textContent = 'Eliminar';
                eliminarButton.classList.add('eliminar-btn');
                eliminarButton.onclick = () => eliminarCertificacion(key); // Pasar la clave única
                accionesCell.appendChild(eliminarButton);
                accionesCell.dataset.label = 'Acciones';
            });
        } else {
            const row = tablaCertificacionesBody.insertRow();
            const cell = row.insertCell();
            cell.colSpan = 8; // Ajustar el colspan al número de columnas
            cell.textContent = 'No hay certificaciones emitidas.';
        }
    }

    function agregarCertificacion() {
        const form = document.getElementById('nuevaCertificacionForm');
        const empresa = form.empresa.value;
        const certificada = form.certificada.value;
        const motivo = form.motivo.value;
        const observaciones = form.observaciones.value;
        const correo = form.correo.value;

        if (empresa && certificada) {
            const nuevaCertificacion = {
                empresa: empresa,
                certificada: certificada,
                motivo: motivo,
                observaciones: observaciones,
                correo: correo
            };

            push(certificacionesRef, nuevaCertificacion)
                .then(() => {
                    alert('Nueva certificación añadida con éxito.');
                    form.reset();
                })
                .catch((error) => {
                    console.error("Error al añadir la certificación:", error);
                    alert('Error al añadir la certificación. Por favor, intenta de nuevo.');
                });
        } else {
            alert('Los campos Empresa y ¿Certificada? son obligatorios.');
        }
    }

    // Escucha los cambios en la base de datos de Firebase para las certificaciones emitidas
    onValue(certificacionesRef, (snapshot) => {
        const data = snapshot.val();
        mostrarCertificaciones(data);
    }, (error) => {
        console.error("Error al leer datos de Firebase:", error);
        tablaCertificacionesBody.innerHTML = '<tr><td colspan="8">Error al cargar las certificaciones.</td></tr>';
    });

    // Asigna la función al scope global para que el onclick en el HTML funcione
    window.agregarCertificacion = agregarCertificacion;
</script>
</body>
</html>